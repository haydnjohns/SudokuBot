import socket
import sys
import termios
import tty
import select

PORT = 5005
HOST = sys.argv[1] if len(sys.argv) > 1 else "raspberrypi.local"

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

print("WASD to drive, q or Ctrl-C to quit")

fd = sys.stdin.fileno()
old_state = termios.tcgetattr(fd)
tty.setcbreak(fd)

def send(cmd: str):
    sock.sendto(cmd.encode(), (HOST, PORT))

try:
    while True:
        rlist, _, _ = select.select([sys.stdin], [], [], 0.1)
        if rlist:
            ch = sys.stdin.read(1).lower()
            if   ch == "w": send("FORWARD")
            elif ch == "a": send("LEFT")
            elif ch == "s": send("BACKWARD")
            elif ch == "d": send("RIGHT")
            elif ch == "q" or ord(ch) in (3, 4):   # q, Ctrl-C, Ctrl-D
                send("QUIT")
                break
finally:
    termios.tcsetattr(fd, termios.TCSADRAIN, old_state)
    print("\nSession ended")
    sock.close()
